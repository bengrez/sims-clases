<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador de Clase (desde video)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1720; --panel2:#101c28; --text:#e6edf3; --muted:#9fb0c0;
      --line:#1f2b38; --accent:#62b0ff; --good:#47d18c; --warn:#ffcc66; --bad:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:radial-gradient(1200px 700px at 10% 10%, #122235, var(--bg));
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{
      max-width:1200px; margin:0 auto; padding:18px;
      display:grid; grid-template-columns: 380px 1fr; gap:14px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr;}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 16px; font-size:14px; letter-spacing:.35px; text-transform:uppercase;
      color:#cfe2f5; background:rgba(255,255,255,.02); border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .content{padding:14px 16px;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select, textarea{
      width:100%; border-radius:12px; border:1px solid var(--line); background:var(--panel);
      color:var(--text); padding:10px 12px; outline:none;
    }
    textarea{min-height:90px; resize:vertical; font-family:var(--sans);}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      border:1px solid var(--line); background:var(--panel2); color:var(--text);
      border-radius:12px; padding:10px 12px; cursor:pointer;
    }
    button.primary{border-color:rgba(98,176,255,.4); background:rgba(98,176,255,.14);}
    button.danger{border-color:rgba(255,107,107,.45); background:rgba(255,107,107,.12);}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .pill{
      font-family:var(--mono); font-size:12px; color:#cfe2f5;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      padding:6px 10px; border-radius:999px;
    }
    .stagebar{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 6px;}
    .stage{
      padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line);
      color:var(--muted); background:rgba(255,255,255,.02);
    }
    .stage.active{color:var(--text); border-color:rgba(98,176,255,.45); background:rgba(98,176,255,.10);}
    .kpis{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px;
    }
    .kpi{
      border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:rgba(255,255,255,.02);
    }
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .v{font-family:var(--mono); font-size:18px; margin-top:4px}
    .kpi .v.good{color:var(--good)}
    .kpi .v.warn{color:var(--warn)}
    .kpi .v.bad{color:var(--bad)}
    .chat{
      height:520px; overflow:auto; padding:12px; background:rgba(0,0,0,.12);
    }
    @media (max-width:980px){ .chat{height:460px;} }
    .msg{
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      border-radius:14px; padding:10px 12px; margin:8px 0;
    }
    .msg .meta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:12px; color:var(--muted); margin-bottom:6px;
    }
    .tag{
      font-family:var(--mono); font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      color:#cfe2f5;
    }
    .tag.teacher{border-color:rgba(98,176,255,.5); background:rgba(98,176,255,.10);}
    .tag.students{border-color:rgba(71,209,140,.5); background:rgba(71,209,140,.10);}
    .tag.system{border-color:rgba(255,204,102,.5); background:rgba(255,204,102,.10);}
    .opts{
      display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px;
    }
    .opt{
      text-align:left; width:100%;
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .opt strong{display:block; margin-bottom:4px}
    .opt small{color:var(--muted)}
    .footerhint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35;}
    .splithead{display:flex; align-items:center; gap:10px;}
    .tiny{font-size:12px; color:var(--muted)}
    .topactions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LEFT: CONFIG -->
    <section class="card">
      <h2>
        <span class="splithead">Configuración <span class="pill" id="runId">run: —</span></span>
        <span class="tiny" id="autosave">autosave: on</span>
      </h2>
      <div class="content">
        <label>Video (URL de YouTube)</label>
        <input id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." />

        <label>Título / tema de la clase</label>
        <input id="topic" placeholder="Ej: Barreras defensivas del cuerpo humano" />

        <div class="row">
          <div>
            <label>Curso / nivel</label>
            <select id="grade">
              <option value="3_basico">3° básico</option>
              <option value="5_basico">5° básico</option>
              <option value="7_basico" selected>7° básico</option>
              <option value="1_medio">I medio</option>
              <option value="3_medio">III medio</option>
            </select>
          </div>
          <div>
            <label>Tono / ritmo</label>
            <select id="tempo">
              <option value="tranquilo">Tranquilo</option>
              <option value="normal" selected>Normal</option>
              <option value="rapido">Rápido</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Objetivo cognitivo</label>
            <select id="cognitive">
              <option value="recordar">Recordar / comprender</option>
              <option value="aplicar" selected>Aplicar</option>
              <option value="analizar">Analizar / discutir</option>
            </select>
          </div>
          <div>
            <label>Dificultad</label>
            <select id="difficulty">
              <option value="baja">Baja</option>
              <option value="media" selected>Media</option>
              <option value="alta">Alta</option>
            </select>
          </div>
        </div>

        <label>Notas del video (lo que observaste)</label>
        <textarea id="notes" placeholder="Ej: el profe parte con pregunta gatillante, luego analogía, luego mini práctica..."></textarea>

        <div class="btnrow">
          <button class="primary" id="btnStart">Iniciar simulación</button>
          <button id="btnNext" disabled>Siguiente paso</button>
          <button id="btnUndo" disabled>Deshacer</button>
          <button class="danger" id="btnReset">Reset</button>
        </div>

        <div class="stagebar" id="stagebar"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">Engagement</div>
            <div class="v" id="kEng">—</div>
          </div>
          <div class="kpi">
            <div class="t">Claridad</div>
            <div class="v" id="kClr">—</div>
          </div>
          <div class="kpi">
            <div class="t">Tiempo (min)</div>
            <div class="v" id="kTime">—</div>
          </div>
        </div>

        <div class="footerhint">
          Esto no “resume” el video: modela una clase como un sistema. Puedes simular decisiones del docente,
          respuestas típicas de estudiantes y efectos en engagement/claridad/tiempo. Se guarda en localStorage.
        </div>
      </div>
    </section>

    <!-- RIGHT: SIM -->
    <section class="card">
      <h2>
        <span>Simulación</span>
        <span class="topactions">
          <span class="pill" id="sessionState">estado: idle</span>
          <button id="btnExport">Exportar JSON</button>
        </span>
      </h2>
      <div class="content" style="padding:0;">
        <div class="chat" id="chat"></div>
        <div class="content">
          <div id="stepTitle" style="font-size:14px; color:#cfe2f5; margin-bottom:8px;">—</div>
          <div id="stepDesc" style="color:var(--muted); line-height:1.35;">Configura y presiona “Iniciar simulación”.</div>
          <div class="opts" id="options"></div>
        </div>
      </div>
    </section>

  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const LS_KEY = "class_sim_v1";
  const nowISO = ()=> new Date().toISOString().replace(/\.\d{3}Z$/, "Z");
  const clamp = (x,min,max)=> Math.max(min, Math.min(max, x));

  const STAGES = [
    { key:"inicio", label:"Inicio (reactivación)" },
    { key:"desarrollo", label:"Desarrollo" },
    { key:"cierre", label:"Cierre + gancho" }
  ];

  function defaultState(){
    return {
      meta: {
        runId: "run_" + Math.random().toString(16).slice(2,8),
        createdAt: nowISO(),
        updatedAt: nowISO(),
      },
      config: {
        videoUrl: "",
        topic: "",
        grade: "7_basico",
        tempo: "normal",
        cognitive: "aplicar",
        difficulty: "media",
        notes: ""
      },
      sim: {
        started: false,
        stageIndex: 0,
        stepIndex: 0,
        choiceMade: false,
        timeMin: 0,
        engagement: 60,
        clarity: 60,
        log: [],
        history: []
      }
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function saveState(st){
    st.meta.updatedAt = nowISO();
    localStorage.setItem(LS_KEY, JSON.stringify(st));
    $("autosave").textContent = "autosave: on";
  }

  function ensureState(st){
    const base = defaultState();
    st = st || base;
    st.meta = st.meta || base.meta;
    st.config = { ...base.config, ...(st.config || {}) };
    st.sim = { ...base.sim, ...(st.sim || {}) };
    return st;
  }

  function scoreClass(n){
    if(n >= 75) return "good";
    if(n >= 55) return "warn";
    return "bad";
  }

  function pushMsg(st, who, text, extra={}){
    st.sim.log.push({
      ts: nowISO(),
      who, text,
      stage: STAGES[st.sim.stageIndex]?.key ?? null,
      step: st.sim.stepIndex,
      ...extra
    });
  }

  function snapshot(st){
    const snap = JSON.parse(JSON.stringify(st.sim));
    st.sim.history.push(snap);
    if(st.sim.history.length > 25) st.sim.history.shift();
  }

  function restoreUndo(st){
    const prev = st.sim.history.pop();
    if(!prev) return false;
    st.sim = prev;
    return true;
  }

  function stageTemplate(st){
    const g = st.config.grade;
    const cog = st.config.cognitive;
    const diff = st.config.difficulty;

    const ageTone = ({
      "3_basico":"muy simple, concreto y visual",
      "5_basico":"simple, con ejemplos cotidianos",
      "7_basico":"intermedio, con analogías y mini-ejercicios",
      "1_medio":"más formal, con conceptos y vocabulario técnico",
      "3_medio":"exigente, con discusión y justificación"
    })[g] || "intermedio";

    const cogMove = ({
      "recordar":"preguntas cortas de recuerdo + definición",
      "aplicar":"mini práctica guiada + ejemplo resuelto",
      "analizar":"discusión de casos + comparación/argumento"
    })[cog] || "mini práctica";

    const diffMove = ({
      "baja":"una sola idea por vez",
      "media":"2–3 ideas conectadas",
      "alta":"caso con trampas / contraejemplos"
    })[diff] || "2 ideas";

    return { ageTone, cogMove, diffMove };
  }

  function mkOpt(title, desc, delta, student){
    return { title, desc, delta, student };
  }

  function buildPlan(st){
    const { ageTone, cogMove, diffMove } = stageTemplate(st);
    const topic = (st.config.topic || "el tema").trim();

    return [
      // INICIO
      [
        {
          title: "Activación rápida",
          desc: `Activa conocimientos previos sobre ${topic}. Mantén el lenguaje ${ageTone}.`,
          teacher: [
            `Pregunta gatillante: “¿Qué recuerdan de ${topic}?”`,
            `Mini sondeo: 2–3 respuestas rápidas, sin corregir aún.`,
            `Ancla: define el objetivo de la clase en 1 frase.`
          ],
          options: [
            mkOpt("Sondeo con ejemplos", "Pides ejemplos cotidianos antes de definir.", {eng:+6, clr:+2, t:+2}, "Varios estudiantes participan con ejemplos."),
            mkOpt("Definición directa", "Das definición breve y luego preguntas.", {eng:+2, clr:+6, t:+1}, "Las respuestas son cortas, pero claras."),
            mkOpt("Error intencional", "Dices una afirmación discutible para provocar.", {eng:+8, clr:-3, t:+3}, "Se activa una discusión rápida.")
          ]
        },
        {
          title: "Modelado de la idea central",
          desc: `Presenta la idea central y conecta con lo que dijeron. Enfócate en ${diffMove}.`,
          teacher: [
            `Usa un ejemplo concreto y valida 1–2 respuestas.`,
            `Conecta con un mapa simple o esquema.`
          ],
          options: [
            mkOpt("Ejemplo guiado", "Resuelves un ejemplo paso a paso.", {eng:+3, clr:+7, t:+3}, "Los estudiantes siguen el procedimiento."),
            mkOpt("Analogía cotidiana", "Usas una analogía simple.", {eng:+6, clr:+3, t:+2}, "La analogía genera nuevas preguntas."),
            mkOpt("Mini debate", "Pides una opinión rápida.", {eng:+5, clr:-1, t:+3}, "Se escuchan posturas distintas.")
          ]
        }
      ],
      // DESARROLLO
      [
        {
          title: "Exploración guiada",
          desc: `Guía una actividad breve. Incorpora ${cogMove}.`,
          teacher: [
            `Divide el problema en pasos pequeños.`,
            `Chequea comprensión cada 2–3 minutos.`
          ],
          options: [
            mkOpt("Trabajo en parejas", "Los estudiantes resuelven en parejas.", {eng:+7, clr:+2, t:+4}, "Aparecen dudas puntuales."),
            mkOpt("Ejercicio individual", "Cada estudiante responde en silencio.", {eng:+2, clr:+4, t:+3}, "Se avanza con menor participación.")
          ]
        },
        {
          title: "Punto de ajuste",
          desc: "Detecta errores típicos y corrige en vivo.",
          teacher: [
            `Muestra 2 errores comunes y cómo corregirlos.`
          ],
          options: [
            mkOpt("Corrección colectiva", "Corriges un error en pizarra.", {eng:+4, clr:+6, t:+3}, "La mayoría entiende la corrección."),
            mkOpt("Pregunta invertida", "Pides que encuentren el error.", {eng:+6, clr:+2, t:+4}, "Algunos identifican el fallo.")
          ]
        }
      ],
      // CIERRE
      [
        {
          title: "Síntesis",
          desc: "Resume la idea clave y verifica comprensión rápida.",
          teacher: [
            `Vuelve al objetivo de la clase y cierra en 2–3 frases.`
          ],
          options: [
            mkOpt("Exit ticket", "Una pregunta corta para salir.", {eng:+3, clr:+5, t:+2}, "Respuestas breves con buen foco."),
            mkOpt("Resumen oral", "Pides a 2 estudiantes resumir.", {eng:+5, clr:+3, t:+3}, "Se escuchan dos versiones." )
          ]
        },
        {
          title: "Gancho",
          desc: "Deja una pregunta abierta para la próxima clase.",
          teacher: [
            `Relaciona con una aplicación real o un caso nuevo.`
          ],
          options: [
            mkOpt("Caso real", "Presentas un caso breve.", {eng:+6, clr:+2, t:+2}, "Se genera curiosidad."),
            mkOpt("Desafío", "Planteas un desafío corto.", {eng:+4, clr:+1, t:+3}, "Algunos piden más tiempo.")
          ]
        }
      ]
    ];
  }

  let state = ensureState(loadState());
  let plan = [];

  function syncInputs(){
    $("videoUrl").value = state.config.videoUrl;
    $("topic").value = state.config.topic;
    $("grade").value = state.config.grade;
    $("tempo").value = state.config.tempo;
    $("cognitive").value = state.config.cognitive;
    $("difficulty").value = state.config.difficulty;
    $("notes").value = state.config.notes;
  }

  function tempoFactor(){
    return ({ tranquilo: 1.2, normal: 1.0, rapido: 0.85 })[state.config.tempo] || 1.0;
  }

  function currentStep(){
    return plan[state.sim.stageIndex]?.[state.sim.stepIndex] || null;
  }

  function renderStagebar(){
    const bar = $("stagebar");
    bar.innerHTML = "";
    STAGES.forEach((s, idx)=>{
      const el = document.createElement("div");
      el.className = "stage" + (idx === state.sim.stageIndex ? " active" : "");
      el.textContent = s.label;
      bar.appendChild(el);
    });
  }

  function renderKPIs(){
    const eng = $("kEng");
    const clr = $("kClr");
    const time = $("kTime");
    eng.textContent = Math.round(state.sim.engagement);
    clr.textContent = Math.round(state.sim.clarity);
    time.textContent = Math.round(state.sim.timeMin);
    eng.className = "v " + scoreClass(state.sim.engagement);
    clr.className = "v " + scoreClass(state.sim.clarity);
  }

  function renderChat(){
    const chat = $("chat");
    chat.innerHTML = "";
    state.sim.log.forEach((m)=>{
      const wrap = document.createElement("div");
      wrap.className = "msg";
      const meta = document.createElement("div");
      meta.className = "meta";
      const tag = document.createElement("span");
      tag.className = `tag ${m.who}`;
      tag.textContent = m.who === "teacher" ? "Docente" : (m.who === "students" ? "Estudiantes" : "Sistema");
      const ts = document.createElement("span");
      ts.textContent = new Date(m.ts).toLocaleTimeString();
      meta.appendChild(tag);
      meta.appendChild(ts);
      const body = document.createElement("div");
      body.textContent = m.text;
      wrap.appendChild(meta);
      wrap.appendChild(body);
      chat.appendChild(wrap);
    });
    chat.scrollTop = chat.scrollHeight;
  }

  function renderStep(){
    const step = currentStep();
    const title = $("stepTitle");
    const desc = $("stepDesc");
    const opts = $("options");

    if(!state.sim.started || !step){
      title.textContent = "—";
      desc.textContent = "Configura y presiona “Iniciar simulación”.";
      opts.innerHTML = "";
      return;
    }

    title.textContent = step.title;
    desc.textContent = step.desc;
    opts.innerHTML = "";

    step.options.forEach((opt)=>{
      const btn = document.createElement("button");
      btn.className = "opt";
      btn.disabled = state.sim.choiceMade;
      btn.innerHTML = `<strong>${opt.title}</strong><small>${opt.desc}</small>`;
      btn.addEventListener("click", ()=> chooseOption(opt));
      opts.appendChild(btn);
    });
  }

  function chooseOption(opt){
    snapshot(state);
    const factor = tempoFactor();
    state.sim.engagement = clamp(state.sim.engagement + opt.delta.eng, 0, 100);
    state.sim.clarity = clamp(state.sim.clarity + opt.delta.clr, 0, 100);
    state.sim.timeMin += Math.max(0, Math.round(opt.delta.t * factor));
    state.sim.choiceMade = true;
    pushMsg(state, "teacher", opt.title);
    if(opt.student) pushMsg(state, "students", opt.student);
    saveState(state);
    renderAll();
  }

  function nextStep(){
    if(!state.sim.started || !state.sim.choiceMade) return;
    snapshot(state);

    state.sim.stepIndex += 1;
    state.sim.choiceMade = false;

    if(!plan[state.sim.stageIndex] || state.sim.stepIndex >= plan[state.sim.stageIndex].length){
      state.sim.stageIndex += 1;
      state.sim.stepIndex = 0;
    }

    if(state.sim.stageIndex >= plan.length){
      state.sim.started = false;
      pushMsg(state, "system", "Simulación finalizada. Revisa tus decisiones y resultados.");
    } else {
      pushMsg(state, "system", `Nuevo paso: ${currentStep().title}`);
    }

    saveState(state);
    renderAll();
  }

  function startSim(){
    state = ensureState(state);
    plan = buildPlan(state);
    state.sim.started = true;
    state.sim.stageIndex = 0;
    state.sim.stepIndex = 0;
    state.sim.choiceMade = false;
    state.sim.timeMin = 0;
    state.sim.engagement = 60;
    state.sim.clarity = 60;
    state.sim.log = [];
    state.sim.history = [];
    pushMsg(state, "system", "Simulación iniciada.");
    saveState(state);
    renderAll();
  }

  function resetAll(){
    localStorage.removeItem(LS_KEY);
    state = defaultState();
    plan = [];
    renderAll();
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `class_sim_${state.meta.runId}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function updateSessionState(){
    const el = $("sessionState");
    if(state.sim.started) el.textContent = "estado: running";
    else el.textContent = state.sim.log.length ? "estado: done" : "estado: idle";
  }

  function renderAll(){
    $("runId").textContent = `run: ${state.meta.runId}`;
    updateSessionState();
    renderStagebar();
    renderKPIs();
    renderChat();
    renderStep();
    $("btnNext").disabled = !state.sim.started || !state.sim.choiceMade;
    $("btnUndo").disabled = state.sim.history.length === 0;
  }

  function bindConfig(){
    $("videoUrl").addEventListener("input", (e)=>{ state.config.videoUrl = e.target.value; saveState(state); });
    $("topic").addEventListener("input", (e)=>{ state.config.topic = e.target.value; saveState(state); });
    $("grade").addEventListener("change", (e)=>{ state.config.grade = e.target.value; saveState(state); });
    $("tempo").addEventListener("change", (e)=>{ state.config.tempo = e.target.value; saveState(state); });
    $("cognitive").addEventListener("change", (e)=>{ state.config.cognitive = e.target.value; saveState(state); });
    $("difficulty").addEventListener("change", (e)=>{ state.config.difficulty = e.target.value; saveState(state); });
    $("notes").addEventListener("input", (e)=>{ state.config.notes = e.target.value; saveState(state); });
  }

  function bindButtons(){
    $("btnStart").addEventListener("click", startSim);
    $("btnNext").addEventListener("click", nextStep);
    $("btnUndo").addEventListener("click", ()=>{
      if(restoreUndo(state)){
        saveState(state);
        renderAll();
      }
    });
    $("btnReset").addEventListener("click", resetAll);
    $("btnExport").addEventListener("click", exportJSON);
  }

  function init(){
    state = ensureState(state);
    syncInputs();
    bindConfig();
    bindButtons();
    renderAll();
  }

  init();
})();
</script>
</body>
</html>
