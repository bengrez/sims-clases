<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Animal Groups Lab v2.1 | Virtual Lab</title>
  <style>
    :root {
      --bg-color: #0f172a;
      --panel-bg: rgba(30, 41, 59, 0.95);
      --panel-bg-strong: rgba(15, 23, 42, 0.95);
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-hover: #0ea5e9;
      --danger: #ef4444;
      --success: #22c55e;
      --warn: #f59e0b;
      --graph-order: #38bdf8;
      --graph-cluster: #22c55e;
      --graph-sync: #fbbf24;
      --shadow: 0 20px 50px rgba(0,0,0,0.5);
      --font-ui: 'Segoe UI', system-ui, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-ui);
      overflow: hidden;
      display: flex;
      height: 100vh;
    }

    input, textarea, select, button { font-family: inherit; }
    input, textarea { user-select: text; }

    /* Canvas Layer */
    #canvas-container {
      flex-grow: 1;
      position: relative;
      cursor: crosshair;
      background: radial-gradient(1100px 700px at 20% 10%, rgba(56,189,248,0.08), transparent);
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* HUD Overlay */
    .hud {
      position: absolute;
      top: 20px;
      left: 20px;
      pointer-events: none;
    }
    .metric-card {
      background: rgba(0,0,0,0.6);
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid var(--accent);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
    }
    .metric-card strong { font-weight: 600; }
    .value-tag { color: var(--accent); }

    .floating-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 30;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .floating-btn:hover { background: rgba(30, 41, 59, 0.95); }

    #graph-drawer {
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;
      height: 220px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid #334155;
      border-radius: 14px;
      box-shadow: var(--shadow);
      transform: translateY(calc(100% + 24px));
      transition: transform 0.25s ease;
      z-index: 20;
      pointer-events: none;
      display: flex;
      flex-direction: column;
    }
    #graph-drawer.open { transform: translateY(0); pointer-events: auto; }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid #334155;
    }
    .drawer-title {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .drawer-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .drawer-actions { display: flex; align-items: center; gap: 8px; }
    .drawer-actions button {
      background: transparent;
      border: 1px solid #334155;
      color: var(--text-main);
      border-radius: 8px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .drawer-body {
      flex-grow: 1;
      padding: 8px 12px 6px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #graphCanvas {
      width: 100%;
      height: 130px;
      border-radius: 10px;
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid #1e293b;
    }
    .drawer-legend {
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .legend-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .legend-line { width: 18px; height: 3px; border-radius: 999px; background: var(--accent); }
    .legend-line.order { background: var(--graph-order); }
    .legend-line.cluster { background: var(--graph-cluster); }
    .legend-line.sync { background: var(--graph-sync); }

    /* Sidebar */
    #sidebar {
      width: 360px;
      background: var(--panel-bg);
      backdrop-filter: blur(10px);
      border-left: 1px solid #334155;
      display: flex;
      flex-direction: column;
      padding: 0;
      transition: transform 0.3s ease;
      z-index: 40;
    }
    .sidebar-header {
      padding: 18px 20px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .sidebar-header h2 { margin: 0; font-size: 1.1rem; color: var(--accent); }
    .header-actions { display: flex; align-items: center; gap: 8px; }
    .header-actions button {
      background: transparent;
      border: 1px solid #334155;
      color: var(--text-main);
      border-radius: 8px;
      padding: 5px 8px;
      cursor: pointer;
    }

    .sidebar-tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid #334155;
    }
    .tab-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 10px 12px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .tab-btn.active { color: var(--text-main); border-bottom: 2px solid var(--accent); }

    .controls-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .controls-container.hidden { display: none; }

    /* Grouping */
    .control-group {
      margin-bottom: 22px;
      border-bottom: 1px solid #334155;
      padding-bottom: 15px;
    }
    .control-group:last-child { border-bottom: none; }
    .group-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Input Elements */
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    .label-text {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .tip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #334155;
      color: var(--text-main);
      font-size: 11px;
      cursor: help;
      position: relative;
    }
    .tip::after {
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      bottom: 130%;
      transform: translateX(-50%);
      background: #0f172a;
      color: var(--text-main);
      border: 1px solid #334155;
      padding: 6px 8px;
      border-radius: 8px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      font-size: 12px;
      box-shadow: var(--shadow);
      transition: opacity 0.2s ease;
    }
    .tip:hover::after { opacity: 1; }

    input[type="range"] {
      width: 100%;
      height: 6px;
      background: #475569;
      border-radius: 3px;
      outline: none;
      appearance: none;
      margin-bottom: 15px;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: background 0.2s;
    }
    select, button {
      width: 100%;
      padding: 10px;
      background: #334155;
      border: 1px solid #475569;
      color: white;
      border-radius: 6px;
      margin-bottom: 10px;
      cursor: pointer;
      font-family: inherit;
    }
    button:hover { background: #475569; }
    button.primary { background: var(--accent); color: #0f172a; font-weight: bold; border: none; }
    button.primary:hover { background: var(--accent-hover); }
    button.danger { border: 1px solid var(--danger); color: var(--danger); background: transparent; }
    button.danger.active { background: var(--danger); color: white; }

    .floating-btn,
    .header-actions button,
    .drawer-actions button,
    .snapshot-actions button {
      width: auto;
      margin: 0;
    }
    .tab-btn { margin: 0; }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .checkbox-row input { width: auto; margin: 0; }

    /* Modal */
    #modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-card {
      background: #1e293b;
      padding: 40px;
      border-radius: 16px;
      max-width: 860px;
      text-align: center;
      border: 1px solid #334155;
      box-shadow: var(--shadow);
    }
    .level-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 30px;
    }
    .level-option {
      background: #0f172a;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .level-option:hover { border-color: var(--accent); transform: translateY(-5px); }
    .level-title { font-size: 1.1rem; color: var(--accent); margin-bottom: 10px; display: block; }
    .level-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.4; }

    /* Notebook */
    .notebook-actions {
      display: grid;
      gap: 10px;
      margin-bottom: 14px;
    }
    .notebook-card {
      background: rgba(2, 6, 23, 0.35);
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .card-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .small-muted { color: var(--text-muted); font-size: 0.8rem; }
    .compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      font-size: 0.8rem;
    }
    .compare-value { font-weight: 600; }
    .compare-value.pos { color: var(--success); }
    .compare-value.neg { color: var(--danger); }

    .note-label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    textarea.note {
      width: 100%;
      min-height: 70px;
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-main);
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 10px;
      resize: vertical;
    }

    .snapshot-list {
      display: grid;
      gap: 10px;
      max-height: 320px;
      overflow: auto;
    }
    .snapshot-card {
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 10px;
      background: rgba(15, 23, 42, 0.8);
    }
    .snapshot-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .snapshot-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-main);
    }
    .snapshot-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .snapshot-actions button { flex: 1; font-size: 0.75rem; padding: 6px; }
    .sparkline {
      width: 100%;
      height: 40px;
      border-radius: 8px;
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid #1e293b;
      margin-top: 8px;
    }

    /* Legend */
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; margin-top: 5px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

    /* Scaffolding Visibility */
    [data-level] { display: none; }
    #modal-overlay [data-level] { display: block; }
    .hidden { display: none !important; }

    @media (max-width: 1000px) {
      body { flex-direction: column; }
      #sidebar {
        width: 100%;
        height: 45vh;
        border-left: none;
        border-top: 1px solid #334155;
      }
      #canvas-container { height: 55vh; }
      .level-grid { grid-template-columns: 1fr; }
      #graph-drawer { left: 12px; right: 12px; }
    }
  </style>
</head>
<body>

  <div id="modal-overlay">
    <div class="modal-card">
      <h1 data-i18n="levelModalTitle">Bienvenido al Laboratorio de Grupos Animales</h1>
      <p data-i18n="levelModalPrompt">Seleccione su nivel educativo para configurar la simulaci√≥n:</p>
      <div class="level-grid">
        <div class="level-option" data-level="basico">
          <span class="level-title" data-i18n="levelBasicTitle">B√°sico (5¬∞-6¬∞)</span>
          <span class="level-desc" data-i18n="levelBasicDesc">Exploraci√≥n visual simple. Observa c√≥mo los animales se agrupan y evitan peligros.</span>
        </div>
        <div class="level-option" data-level="media">
          <span class="level-title" data-i18n="levelMidTitle">Media (7¬∞-II¬∞)</span>
          <span class="level-desc" data-i18n="levelMidDesc">Experimentaci√≥n completa. Ajusta variables, a√≠sla reglas y analiza datos.</span>
        </div>
        <div class="level-option" data-level="avanzado">
          <span class="level-title" data-i18n="levelAdvTitle">Avanzado (Univ.)</span>
          <span class="level-desc" data-i18n="levelAdvDesc">Modelado matem√°tico. Par√°metros de Kuramoto y transiciones de fase.</span>
        </div>
      </div>
    </div>
  </div>

  <div id="canvas-container">
    <canvas id="simCanvas"></canvas>
    <div class="hud">
      <div class="metric-card">
        <div><span data-i18n="hudAgents">Agentes</span>: <span id="val-count" class="value-tag">0</span></div>
        <div><span data-i18n="hudFps">FPS</span>: <span id="val-fps" class="value-tag">0</span></div>
        <div data-level="media avanzado"><span data-i18n="hudTime">Tiempo</span>: <span id="val-time" class="value-tag">00:00</span></div>
      </div>
      <div class="metric-card" data-level="media avanzado">
        <div style="font-weight:bold; margin-bottom:5px;" data-i18n="hudGroupMetrics">M√©tricas de Grupo</div>
        <div><span data-i18n="metricOrder">Orden (œà)</span>: <span id="val-order" class="value-tag">0.00</span></div>
        <div><span data-i18n="metricCluster">Clustering</span>: <span id="val-cluster" class="value-tag">0%</span></div>
        <div data-level="avanzado"><span data-i18n="metricSync">Sync (r)</span>: <span id="val-sync" class="value-tag">0.00</span></div>
      </div>
      <div id="inquiry-box" class="metric-card" style="border-left-color: var(--success); max-width: 300px;">
        <em id="inquiry-text">...</em>
      </div>
    </div>

    <button id="graph-toggle" class="floating-btn" data-i18n-title="graphToggleOpen" title="Gr√°ficos">üìà</button>

    <div id="graph-drawer">
      <div class="drawer-header">
        <div>
          <div class="drawer-title" data-i18n="graphTitle">Instrumentaci√≥n en Vivo</div>
          <div class="drawer-subtitle" data-i18n="graphSubtitle">Ventana 30s, escala 0-1</div>
        </div>
        <div class="drawer-actions">
          <button id="graph-close" data-i18n="graphToggleClose">Cerrar</button>
        </div>
      </div>
      <div class="drawer-body">
        <canvas id="graphCanvas"></canvas>
        <div class="drawer-legend">
          <label class="legend-chip">
            <input type="checkbox" id="graph-order" checked>
            <span class="legend-line order"></span>
            <span data-i18n="graphOrder">Orden</span>
          </label>
          <label class="legend-chip">
            <input type="checkbox" id="graph-cluster" checked>
            <span class="legend-line cluster"></span>
            <span data-i18n="graphCluster">Clustering</span>
          </label>
          <label class="legend-chip" data-level="avanzado" data-display="inline-flex">
            <input type="checkbox" id="graph-sync" checked>
            <span class="legend-line sync"></span>
            <span data-i18n="graphSync">Sincronizaci√≥n</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <div id="sidebar">
    <div class="sidebar-header">
      <h2 data-i18n="sidebarTitle">Configuraci√≥n</h2>
      <div class="header-actions">
        <button id="btn-lang">ES / EN</button>
        <button id="btn-reset" title="Reset">‚Ü∫</button>
      </div>
    </div>

    <div class="sidebar-tabs">
      <button class="tab-btn active" data-tab="controls" data-i18n="tabControls">Controles</button>
      <button class="tab-btn" data-tab="notebook" data-i18n="tabNotebook">Cuaderno</button>
    </div>

    <div class="controls-container" data-tab-panel="controls">
      <div class="control-group">
        <div class="group-title" data-i18n="groupEnvironment">Entorno</div>

        <label class="label-row">
          <span class="label-text" data-i18n="labelPreset">Especies (Presets)</span>
        </label>
        <select id="preset-select">
          <option value="custom" data-i18n="presetCustom">Personalizado</option>
          <option value="starlings" data-i18n="presetStarlings">Estorninos (Murmuration)</option>
          <option value="fish" data-i18n="presetFish">Banco de Peces (School)</option>
          <option value="locusts" data-i18n="presetLocusts">Langostas (Swarm)</option>
          <option value="fireflies" data-i18n="presetFireflies" data-level="avanzado">Luci√©rnagas (Sync)</option>
        </select>

        <label class="label-row">
          <span class="label-text">
            <span data-i18n="labelCount">N√∫mero de Agentes</span>
          </span>
          <span id="disp-count" class="value-tag">150</span>
        </label>
        <input type="range" id="param-count" min="10" max="800" step="10" value="150">

        <label class="label-row" data-level="media avanzado" data-display="flex">
          <span class="label-text">
            <span data-i18n="labelVisionRadius">Radio de Visi√≥n</span>
            <span class="tip" data-tip-key="tipVision">?</span>
          </span>
          <span id="disp-vision" class="value-tag">60</span>
        </label>
        <input data-level="media avanzado" type="range" id="param-vision" min="20" max="120" step="5" value="60">

        <label class="label-row" data-level="media avanzado" data-display="flex">
          <span class="label-text">
            <span data-i18n="labelSpeed">Velocidad M√°xima</span>
          </span>
          <span id="disp-speed" class="value-tag">3.0</span>
        </label>
        <input data-level="media avanzado" type="range" id="param-speed" min="1" max="6" step="0.1" value="3">

        <button id="btn-predator" class="danger" data-i18n="labelPredator">‚ö†Ô∏è Activar Depredador (P)</button>
      </div>

      <div class="control-group" data-level="basico media avanzado">
        <div class="group-title" data-i18n="groupRules">Reglas de Comportamiento (Boids)</div>

        <div data-level="media avanzado" data-display="block">
          <label class="label-row">
            <span class="label-text" data-i18n="labelIsolation">Aislamiento de Regla</span>
          </label>
          <select id="rule-isolate">
            <option value="all" data-i18n="isolationAll">Todas las reglas activas</option>
            <option value="sep" data-i18n="isolationSep">Solo Separaci√≥n</option>
            <option value="ali" data-i18n="isolationAli">Solo Alineaci√≥n</option>
            <option value="coh" data-i18n="isolationCoh">Solo Cohesi√≥n</option>
          </select>
        </div>

        <label class="label-row">
          <span class="label-text">
            <span data-i18n="labelSeparation">Separaci√≥n (Evitar choque)</span>
            <span class="tip" data-tip-key="tipSeparation">?</span>
          </span>
          <span id="disp-sep" class="value-tag">1.5</span>
        </label>
        <input type="range" id="param-sep" min="0" max="5" step="0.1" value="1.5">

        <label class="label-row">
          <span class="label-text">
            <span data-i18n="labelAlignment">Alineaci√≥n (Copiar rumbo)</span>
            <span class="tip" data-tip-key="tipAlignment">?</span>
          </span>
          <span id="disp-ali" class="value-tag">1.0</span>
        </label>
        <input type="range" id="param-ali" min="0" max="5" step="0.1" value="1.0">

        <label class="label-row">
          <span class="label-text">
            <span data-i18n="labelCohesion">Cohesi√≥n (Mantenerse juntos)</span>
            <span class="tip" data-tip-key="tipCohesion">?</span>
          </span>
          <span id="disp-coh" class="value-tag">1.0</span>
        </label>
        <input type="range" id="param-coh" min="0" max="5" step="0.1" value="1.0">
      </div>

      <div class="control-group" data-level="avanzado">
        <div class="group-title" data-i18n="groupKuramoto">Modelo Kuramoto (Sincronizaci√≥n)</div>
        <label class="label-row">
          <span class="label-text">
            <span data-i18n="labelK">Acoplamiento (K)</span>
            <span class="tip" data-tip-key="tipKuramoto">?</span>
          </span>
          <span id="disp-k" class="value-tag">0.0</span>
        </label>
        <input type="range" id="param-k" min="0" max="5" step="0.1" value="0">
        <div class="legend-item" data-level="avanzado" data-display="flex"><span class="dot" style="background:white"></span> <span data-i18n="legendPhase">Fase (Color oscilante)</span></div>
      </div>

      <div class="control-group" data-level="media avanzado">
        <div class="group-title" data-i18n="groupViz">Visualizaci√≥n & Datos</div>

        <label class="checkbox-row" data-level="media avanzado" data-display="flex">
          <input type="checkbox" id="check-vision">
          <span data-i18n="labelVision">Mostrar Radio de Visi√≥n</span>
        </label>

        <label class="checkbox-row" data-level="media avanzado" data-display="flex">
          <input type="checkbox" id="check-vectors">
          <span data-i18n="labelVectors">Ver Vectores de Fuerza</span>
        </label>

        <div class="legend-item" id="leg-sep"><span class="dot" style="background:var(--danger)"></span> <span data-i18n="legendSep">Separaci√≥n</span></div>
        <div class="legend-item" id="leg-ali"><span class="dot" style="background:var(--success)"></span> <span data-i18n="legendAli">Alineaci√≥n</span></div>
        <div class="legend-item" id="leg-coh"><span class="dot" style="background:var(--accent)"></span> <span data-i18n="legendCoh">Cohesi√≥n</span></div>

        <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <button class="primary" id="btn-csv" data-i18n="btnCsv">üì• CSV</button>
          <button class="primary" id="btn-json" data-i18n="btnJson">üì• JSON</button>
        </div>
      </div>
    </div>

    <div class="controls-container hidden" data-tab-panel="notebook">
      <div class="notebook-actions">
        <button class="primary" id="btn-snapshot" data-i18n="notebookCapture">üìå Capturar Snapshot</button>
        <button id="btn-control" data-i18n="notebookSetControl">A: Fijar Control</button>
        <label class="checkbox-row" data-display="flex">
          <input type="checkbox" id="toggle-compare">
          <span data-i18n="notebookCompareToggle">Comparar con Control A</span>
        </label>
      </div>

      <div class="notebook-card" id="control-card">
        <div class="card-title" data-i18n="notebookControlTitle">Control A</div>
        <div id="control-body" class="small-muted" data-i18n="notebookControlEmpty">A√∫n no hay control.</div>
        <div class="snapshot-actions hidden" id="control-actions">
          <button id="btn-clear-control" data-i18n="notebookClearControl">Quitar Control</button>
        </div>
      </div>

      <div class="notebook-card" id="compare-card">
        <div class="card-title" data-i18n="notebookCompareTitle">Comparaci√≥n en vivo</div>
        <div class="compare-grid">
          <div><span data-i18n="metricOrder">Orden (œà)</span>: <span id="cmp-order" class="compare-value">‚Äî</span></div>
          <div><span data-i18n="metricCluster">Clustering</span>: <span id="cmp-cluster" class="compare-value">‚Äî</span></div>
          <div><span data-i18n="metricSync">Sync (r)</span>: <span id="cmp-sync" class="compare-value">‚Äî</span></div>
        </div>
        <div class="small-muted" data-i18n="notebookCompareHint">Activa el modo para ver Delta vs Control.</div>
      </div>

      <div class="notebook-card" data-level="basico">
        <div class="card-title" data-i18n="tierBasicTitle">Nivel B√°sico: Observaci√≥n</div>
        <label class="note-label" data-i18n="tierBasicPrompt1">¬øQu√© patr√≥n ves en el movimiento?</label>
        <textarea class="note" data-i18n-placeholder="tierBasicPlaceholder1"></textarea>
        <label class="note-label" data-i18n="tierBasicPrompt2">¬øQu√© cambia cuando aparece el depredador?</label>
        <textarea class="note" data-i18n-placeholder="tierBasicPlaceholder2"></textarea>
      </div>

      <div class="notebook-card" data-level="media">
        <div class="card-title" data-i18n="tierMediaTitle">Nivel Medio: Hip√≥tesis</div>
        <label class="note-label" data-i18n="tierMediaPrompt1">Hip√≥tesis</label>
        <textarea class="note" data-i18n-placeholder="tierMediaPlaceholder1"></textarea>
        <label class="note-label" data-i18n="tierMediaPrompt2">Variables independientes</label>
        <textarea class="note" data-i18n-placeholder="tierMediaPlaceholder2"></textarea>
        <label class="note-label" data-i18n="tierMediaPrompt3">Variables dependientes</label>
        <textarea class="note" data-i18n-placeholder="tierMediaPlaceholder3"></textarea>
        <label class="note-label" data-i18n="tierMediaPrompt4">Resultados</label>
        <textarea class="note" data-i18n-placeholder="tierMediaPlaceholder4"></textarea>
      </div>

      <div class="notebook-card" data-level="avanzado">
        <div class="card-title" data-i18n="tierAdvTitle">Nivel Avanzado: Modelo</div>
        <label class="note-label" data-i18n="tierAdvPrompt1">Modelo / ecuaciones</label>
        <textarea class="note" data-i18n-placeholder="tierAdvPlaceholder1"></textarea>
        <label class="note-label" data-i18n="tierAdvPrompt2">Variables de control</label>
        <textarea class="note" data-i18n-placeholder="tierAdvPlaceholder2"></textarea>
        <label class="note-label" data-i18n="tierAdvPrompt3">An√°lisis de transici√≥n</label>
        <textarea class="note" data-i18n-placeholder="tierAdvPlaceholder3"></textarea>
      </div>

      <div class="notebook-card">
        <div class="card-title" data-i18n="notebookSnapshotsTitle">Snapshots</div>
        <div id="snapshots-list" class="snapshot-list"></div>
      </div>
    </div>
  </div>

  <script>
    const I18N = {
      es: {
        levelModalTitle: "Bienvenido al Laboratorio de Grupos Animales",
        levelModalPrompt: "Seleccione su nivel educativo para configurar la simulaci√≥n:",
        levelBasicTitle: "B√°sico (5¬∞-6¬∞)",
        levelBasicDesc: "Exploraci√≥n visual simple. Observa c√≥mo los animales se agrupan y evitan peligros.",
        levelMidTitle: "Media (7¬∞-II¬∞)",
        levelMidDesc: "Experimentaci√≥n completa. Ajusta variables, a√≠sla reglas y analiza datos.",
        levelAdvTitle: "Avanzado (Univ.)",
        levelAdvDesc: "Modelado matem√°tico. Par√°metros de Kuramoto y transiciones de fase.",
        hudAgents: "Agentes",
        hudFps: "FPS",
        hudTime: "Tiempo",
        hudGroupMetrics: "M√©tricas de Grupo",
        metricOrder: "Orden (œà)",
        metricCluster: "Clustering",
        metricSync: "Sync (r)",
        sidebarTitle: "Configuraci√≥n",
        tabControls: "Controles",
        tabNotebook: "Cuaderno",
        groupEnvironment: "Entorno",
        labelPreset: "Especies (Presets)",
        presetCustom: "Personalizado",
        presetStarlings: "Estorninos (Murmuration)",
        presetFish: "Banco de Peces (School)",
        presetLocusts: "Langostas (Swarm)",
        presetFireflies: "Luci√©rnagas (Sync)",
        labelCount: "N√∫mero de Agentes",
        labelVisionRadius: "Radio de Visi√≥n",
        labelSpeed: "Velocidad M√°xima",
        labelPredator: "‚ö†Ô∏è Activar Depredador (P)",
        labelPredatorOff: "‚õî Desactivar Depredador (P)",
        groupRules: "Reglas de Comportamiento (Boids)",
        labelIsolation: "Aislamiento de Regla",
        isolationAll: "Todas las reglas activas",
        isolationSep: "Solo Separaci√≥n",
        isolationAli: "Solo Alineaci√≥n",
        isolationCoh: "Solo Cohesi√≥n",
        labelSeparation: "Separaci√≥n (Evitar choque)",
        labelAlignment: "Alineaci√≥n (Copiar rumbo)",
        labelCohesion: "Cohesi√≥n (Mantenerse juntos)",
        groupKuramoto: "Modelo Kuramoto (Sincronizaci√≥n)",
        labelK: "Acoplamiento (K)",
        legendPhase: "Fase (Color oscilante)",
        groupViz: "Visualizaci√≥n & Datos",
        labelVision: "Mostrar Radio de Visi√≥n",
        labelVectors: "Ver Vectores de Fuerza",
        legendSep: "Separaci√≥n",
        legendAli: "Alineaci√≥n",
        legendCoh: "Cohesi√≥n",
        btnCsv: "üì• CSV",
        btnJson: "üì• JSON",
        graphTitle: "Instrumentaci√≥n en Vivo",
        graphSubtitle: "Ventana 30s, escala 0-1",
        graphOrder: "Orden",
        graphCluster: "Clustering",
        graphSync: "Sincronizaci√≥n",
        graphToggleOpen: "Gr√°ficos",
        graphToggleClose: "Cerrar",
        notebookCapture: "üìå Capturar Snapshot",
        notebookSetControl: "A: Fijar Control",
        notebookCompareToggle: "Comparar con Control A",
        notebookControlTitle: "Control A",
        notebookControlEmpty: "A√∫n no hay control.",
        notebookClearControl: "Quitar Control",
        notebookCompareTitle: "Comparaci√≥n en vivo",
        notebookCompareHint: "Activa el modo para ver Delta vs Control.",
        notebookSnapshotsTitle: "Snapshots",
        notebookSnapshotsEmpty: "Sin snapshots a√∫n.",
        notebookUseAsControl: "Usar como Control",
        notebookDelete: "Eliminar",
        tierBasicTitle: "Nivel B√°sico: Observaci√≥n",
        tierBasicPrompt1: "¬øQu√© patr√≥n ves en el movimiento?",
        tierBasicPrompt2: "¬øQu√© cambia cuando aparece el depredador?",
        tierBasicPlaceholder1: "Ej: Se forman grupos circulares...",
        tierBasicPlaceholder2: "Ej: Se compactan y cambian direcci√≥n...",
        tierMediaTitle: "Nivel Medio: Hip√≥tesis",
        tierMediaPrompt1: "Hip√≥tesis",
        tierMediaPrompt2: "Variables independientes",
        tierMediaPrompt3: "Variables dependientes",
        tierMediaPrompt4: "Resultados",
        tierMediaPlaceholder1: "Ej: Si aumento la separaci√≥n...",
        tierMediaPlaceholder2: "Ej: separaci√≥n, alineaci√≥n, K...",
        tierMediaPlaceholder3: "Ej: orden, clustering, sync...",
        tierMediaPlaceholder4: "Ej: el orden baj√≥ al activar depredador...",
        tierAdvTitle: "Nivel Avanzado: Modelo",
        tierAdvPrompt1: "Modelo / ecuaciones",
        tierAdvPrompt2: "Variables de control",
        tierAdvPrompt3: "An√°lisis de transici√≥n",
        tierAdvPlaceholder1: "Ej: dŒ∏/dt = œâ + (K/N) Œ£ sin(Œ∏j-Œ∏i)",
        tierAdvPlaceholder2: "Ej: densidad, borde, visi√≥n...",
        tierAdvPlaceholder3: "Ej: umbral cr√≠tico Kc ~ 1.8",
        tipSeparation: "Evita choques: fuerza de repulsi√≥n local.",
        tipAlignment: "Imita la direcci√≥n promedio del vecindario.",
        tipCohesion: "Se acerca al centro del grupo cercano.",
        tipVision: "Distancia m√°xima para percibir vecinos.",
        tipKuramoto: "Aumenta el acoplamiento de fases.",
        alertNoData: "No hay datos recolectados a√∫n. Deja correr la simulaci√≥n.",
        labelPredatorOnShort: "Depredador: ON",
        labelPredatorOffShort: "Depredador: OFF",
        levelBasicoShort: "B√°sico",
        levelMediaShort: "Media",
        levelAvanzadoShort: "Avanzado"
      },
      en: {
        levelModalTitle: "Welcome to the Animal Groups Lab",
        levelModalPrompt: "Select your education level to configure the simulation:",
        levelBasicTitle: "Basic (Grades 5-6)",
        levelBasicDesc: "Simple visual exploration. Watch how animals group and avoid danger.",
        levelMidTitle: "Middle (Grades 7-10)",
        levelMidDesc: "Full experimentation. Adjust variables, isolate rules, analyze data.",
        levelAdvTitle: "Advanced (Univ.)",
        levelAdvDesc: "Mathematical modeling. Kuramoto parameters and phase transitions.",
        hudAgents: "Agents",
        hudFps: "FPS",
        hudTime: "Time",
        hudGroupMetrics: "Group Metrics",
        metricOrder: "Order (œà)",
        metricCluster: "Clustering",
        metricSync: "Sync (r)",
        sidebarTitle: "Configuration",
        tabControls: "Controls",
        tabNotebook: "Notebook",
        groupEnvironment: "Environment",
        labelPreset: "Species (Presets)",
        presetCustom: "Custom",
        presetStarlings: "Starlings (Murmuration)",
        presetFish: "School of Fish",
        presetLocusts: "Locusts (Swarm)",
        presetFireflies: "Fireflies (Sync)",
        labelCount: "Agent Count",
        labelVisionRadius: "Vision Radius",
        labelSpeed: "Max Speed",
        labelPredator: "‚ö†Ô∏è Activate Predator (P)",
        labelPredatorOff: "‚õî Deactivate Predator (P)",
        groupRules: "Behavior Rules (Boids)",
        labelIsolation: "Rule Isolation",
        isolationAll: "All rules active",
        isolationSep: "Separation only",
        isolationAli: "Alignment only",
        isolationCoh: "Cohesion only",
        labelSeparation: "Separation (avoid collision)",
        labelAlignment: "Alignment (match heading)",
        labelCohesion: "Cohesion (stay together)",
        groupKuramoto: "Kuramoto Model (Synchronization)",
        labelK: "Coupling (K)",
        legendPhase: "Phase (color oscillation)",
        groupViz: "Visualization & Data",
        labelVision: "Show Vision Radius",
        labelVectors: "Show Force Vectors",
        legendSep: "Separation",
        legendAli: "Alignment",
        legendCoh: "Cohesion",
        btnCsv: "üì• CSV",
        btnJson: "üì• JSON",
        graphTitle: "Live Instrumentation",
        graphSubtitle: "30s window, 0-1 scale",
        graphOrder: "Order",
        graphCluster: "Clustering",
        graphSync: "Synchronization",
        graphToggleOpen: "Graphs",
        graphToggleClose: "Close",
        notebookCapture: "üìå Capture Snapshot",
        notebookSetControl: "A: Set Control",
        notebookCompareToggle: "Compare to Control A",
        notebookControlTitle: "Control A",
        notebookControlEmpty: "No control set yet.",
        notebookClearControl: "Clear Control",
        notebookCompareTitle: "Live Comparison",
        notebookCompareHint: "Enable to see Delta vs Control.",
        notebookSnapshotsTitle: "Snapshots",
        notebookSnapshotsEmpty: "No snapshots yet.",
        notebookUseAsControl: "Use as Control",
        notebookDelete: "Delete",
        tierBasicTitle: "Basic Level: Observation",
        tierBasicPrompt1: "What pattern do you see in the motion?",
        tierBasicPrompt2: "What changes when the predator appears?",
        tierBasicPlaceholder1: "E.g., groups form circles...",
        tierBasicPlaceholder2: "E.g., they compress and turn...",
        tierMediaTitle: "Middle Level: Hypothesis",
        tierMediaPrompt1: "Hypothesis",
        tierMediaPrompt2: "Independent variables",
        tierMediaPrompt3: "Dependent variables",
        tierMediaPrompt4: "Results",
        tierMediaPlaceholder1: "E.g., if I increase separation...",
        tierMediaPlaceholder2: "E.g., separation, alignment, K...",
        tierMediaPlaceholder3: "E.g., order, clustering, sync...",
        tierMediaPlaceholder4: "E.g., order dropped with predator...",
        tierAdvTitle: "Advanced Level: Model",
        tierAdvPrompt1: "Model / equations",
        tierAdvPrompt2: "Control variables",
        tierAdvPrompt3: "Transition analysis",
        tierAdvPlaceholder1: "E.g., dŒ∏/dt = œâ + (K/N) Œ£ sin(Œ∏j-Œ∏i)",
        tierAdvPlaceholder2: "E.g., density, boundaries, vision...",
        tierAdvPlaceholder3: "E.g., critical threshold Kc ~ 1.8",
        tipSeparation: "Avoid collisions: local repulsion force.",
        tipAlignment: "Align with the average neighbor heading.",
        tipCohesion: "Move toward the local group center.",
        tipVision: "Maximum distance to perceive neighbors.",
        tipKuramoto: "Increase phase coupling strength.",
        alertNoData: "No data collected yet. Let the simulation run.",
        labelPredatorOnShort: "Predator: ON",
        labelPredatorOffShort: "Predator: OFF",
        levelBasicoShort: "Basic",
        levelMediaShort: "Middle",
        levelAvanzadoShort: "Advanced"
      }
    };

    const QUESTIONS = {
      es: {
        basico: "¬øC√≥mo reacciona el grupo cuando aparece el depredador?",
        media: "Prueba: Desactiva Alineaci√≥n. ¬øEl grupo sigue unido?",
        avanzado: "¬øA qu√© valor de K ocurre la transici√≥n de fase?"
      },
      en: {
        basico: "How does the group react when the predator appears?",
        media: "Try: Disable alignment. Does the group stay together?",
        avanzado: "At what K value does the phase transition occur?"
      }
    };

    // --- Math & Physics Utilities ---
    const Vec2 = {
      add: (v1, v2) => ({ x: v1.x + v2.x, y: v1.y + v2.y }),
      sub: (v1, v2) => ({ x: v1.x - v2.x, y: v1.y - v2.y }),
      mult: (v, n) => ({ x: v.x * n, y: v.y * n }),
      div: (v, n) => ({ x: v.x / n, y: v.y / n }),
      mag: (v) => Math.sqrt(v.x * v.x + v.y * v.y),
      normalize: (v) => {
        const m = Math.sqrt(v.x * v.x + v.y * v.y);
        return m === 0 ? { x: 0, y: 0 } : { x: v.x / m, y: v.y / m };
      },
      limit: (v, max) => {
        const m = Math.sqrt(v.x * v.x + v.y * v.y);
        if (m > max) {
          const n = { x: v.x / m, y: v.y / m };
          return { x: n.x * max, y: n.y * max };
        }
        return v;
      },
      dist: (v1, v2) => Math.sqrt((v1.x - v2.x) ** 2 + (v1.y - v2.y) ** 2)
    };

    const config = {
      level: 'basico',
      count: 150,
      visionRadius: 60,
      maxSpeed: 3,
      maxForce: 0.05,
      sepMult: 1.5,
      aliMult: 1.0,
      cohMult: 1.0,
      kuramotoK: 0.0,
      predatorActive: false,
      showVision: false,
      showVectors: false,
      isolation: 'all',
      paused: false
    };

    const state = {
      agents: [],
      predator: { x: 0, y: 0 },
      width: 0,
      height: 0,
      metrics: { order: 0, cluster: 0, sync: 0 },
      history: [],
      timeSec: 0,
      frame: 0,
      fps: 0,
      historyAcc: 0,
      graph: {
        samples: [],
        events: [],
        windowSec: 30,
        sampleMs: 200,
        sampleAcc: 0,
        series: { order: true, cluster: true, sync: true }
      },
      notebook: {
        snapshots: [],
        control: null,
        compare: false
      },
      lang: 'es',
      graphOpen: false,
      lastFrame: 0
    };

    const PRESETS = {
      starlings: { sep: 1.5, ali: 1.3, coh: 0.9, speed: 4.0, vision: 80, k: 0 },
      fish:      { sep: 1.0, ali: 0.8, coh: 1.2, speed: 2.5, vision: 50, k: 0 },
      locusts:   { sep: 0.6, ali: 1.5, coh: 0.4, speed: 3.5, vision: 60, k: 0 },
      fireflies: { sep: 0.5, ali: 0.0, coh: 0.0, speed: 0.5, vision: 100, k: 3.0 }
    };

    const $ = (id) => document.getElementById(id);

    const app = {
      init: () => {
        app.canvas = $('simCanvas');
        app.ctx = app.canvas.getContext('2d');
        app.graphCanvas = $('graphCanvas');
        app.graphCtx = app.graphCanvas.getContext('2d');

        app.bindInputs();
        app.bindTabs();
        app.bindLanguage();

        app.resize();
        window.addEventListener('resize', app.resize);

        document.querySelectorAll('.level-option').forEach((opt) => {
          opt.addEventListener('click', () => app.setLevel(opt.dataset.level));
        });

        // Mouse/Touch Interaction
        app.canvas.addEventListener('mousemove', (e) => {
          const rect = app.canvas.getBoundingClientRect();
          state.predator = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        });
        app.canvas.addEventListener('touchmove', (e) => {
          const rect = app.canvas.getBoundingClientRect();
          const touch = e.touches[0];
          if (!touch) return;
          state.predator = { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        }, { passive: true });

        app.reset();
        app.loop(performance.now());
      },

      resize: () => {
        const resizeCanvas = (canvas, ctx, width, height) => {
          const dpr = window.devicePixelRatio || 1;
          canvas.width = width * dpr;
          canvas.height = height * dpr;
          canvas.style.width = width + 'px';
          canvas.style.height = height + 'px';
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        };

        const container = $('canvas-container');
        resizeCanvas(app.canvas, app.ctx, container.offsetWidth, container.offsetHeight);
        state.width = app.canvas.width / (window.devicePixelRatio || 1);
        state.height = app.canvas.height / (window.devicePixelRatio || 1);

        const drawer = $('graph-drawer');
        const drawerHeight = drawer.clientHeight - 70;
        const drawerWidth = drawer.clientWidth - 24;
        resizeCanvas(app.graphCanvas, app.graphCtx, drawerWidth, Math.max(80, drawerHeight));
      },

      bindInputs: () => {
        const bind = (id, key, displayId, decimals = 1) => {
          const el = $(id);
          if (!el) return;
          el.addEventListener('input', (e) => app.updateConfig(key, e.target.value, displayId, decimals));
        };

        bind('param-count', 'count', 'disp-count', 0);
        bind('param-sep', 'sepMult', 'disp-sep', 1);
        bind('param-ali', 'aliMult', 'disp-ali', 1);
        bind('param-coh', 'cohMult', 'disp-coh', 1);
        bind('param-k', 'kuramotoK', 'disp-k', 1);
        bind('param-vision', 'visionRadius', 'disp-vision', 0);
        bind('param-speed', 'maxSpeed', 'disp-speed', 1);

        $('preset-select').addEventListener('change', (e) => app.loadPreset(e.target.value));
        $('rule-isolate').addEventListener('change', (e) => app.setIsolation(e.target.value));
        $('btn-predator').addEventListener('click', app.togglePredator);
        $('check-vision').addEventListener('change', app.toggleVision);
        $('check-vectors').addEventListener('change', app.toggleVectors);
        $('btn-reset').addEventListener('click', app.reset);
        $('btn-csv').addEventListener('click', () => app.exportData('csv'));
        $('btn-json').addEventListener('click', () => app.exportData('json'));
        $('graph-toggle').addEventListener('click', app.toggleGraph);
        $('graph-close').addEventListener('click', app.toggleGraph);
        $('graph-order').addEventListener('change', (e) => { state.graph.series.order = e.target.checked; });
        $('graph-cluster').addEventListener('change', (e) => { state.graph.series.cluster = e.target.checked; });
        $('graph-sync').addEventListener('change', (e) => { state.graph.series.sync = e.target.checked; });
        $('btn-snapshot').addEventListener('click', app.captureSnapshot);
        $('btn-control').addEventListener('click', app.setControlFromCurrent);
        $('btn-clear-control').addEventListener('click', app.clearControl);
        $('toggle-compare').addEventListener('change', (e) => {
          state.notebook.compare = e.target.checked;
          app.updateCompare();
        });

        // Keybindings
        window.addEventListener('keydown', (e) => {
          if (e.code === 'Space') config.paused = !config.paused;
          if (e.code === 'KeyR') app.reset();
          if (e.code === 'KeyP') app.togglePredator();
          if (e.code === 'KeyD') app.toggleVectors();
          if (e.code === 'KeyV') app.toggleVision();
        });
      },

      bindTabs: () => {
        document.querySelectorAll('.tab-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            const tab = btn.dataset.tab;
            document.querySelectorAll('[data-tab-panel]').forEach((panel) => {
              panel.classList.toggle('hidden', panel.dataset.tabPanel !== tab);
            });
          });
        });
      },

      bindLanguage: () => {
        const stored = localStorage.getItem('agl_lang');
        if (stored && I18N[stored]) state.lang = stored;
        $('btn-lang').addEventListener('click', () => {
          state.lang = state.lang === 'es' ? 'en' : 'es';
          localStorage.setItem('agl_lang', state.lang);
          app.applyTranslations();
          app.updatePredatorButton();
          app.updateInquiry();
          app.renderControl();
          app.renderSnapshots();
          app.updateCompare();
        });
        app.applyTranslations();
      },

      applyTranslations: () => {
        const t = (key) => (I18N[state.lang] && I18N[state.lang][key]) || key;
        document.documentElement.lang = state.lang;

        document.querySelectorAll('[data-i18n]').forEach((el) => {
          el.textContent = t(el.dataset.i18n);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
          el.placeholder = t(el.dataset.i18nPlaceholder);
        });
        document.querySelectorAll('[data-i18n-title]').forEach((el) => {
          el.title = t(el.dataset.i18nTitle);
        });
        document.querySelectorAll('[data-tip-key]').forEach((el) => {
          el.setAttribute('data-tip', t(el.dataset.tipKey));
        });
      },

      setLevel: (level) => {
        config.level = level;
        $('modal-overlay').style.display = 'none';

        app.applyLevelVisibility(level);
        app.updateInquiry();

        const countMax = level === 'basico' ? 150 : (level === 'media' ? 600 : 1000);
        const countSlider = $('param-count');
        countSlider.max = countMax;
        if (config.count > countMax) {
          app.updateConfig('count', countMax, 'disp-count', 0);
          countSlider.value = countMax;
        }

        if (level !== 'avanzado') {
          config.kuramotoK = 0;
          $('param-k').value = 0;
          $('disp-k').textContent = '0.0';
          state.graph.series.sync = false;
          $('graph-sync').checked = false;
        } else {
          state.graph.series.sync = true;
          $('graph-sync').checked = true;
        }
      },

      applyLevelVisibility: (level) => {
        document.querySelectorAll('[data-level]').forEach((el) => {
          const levels = el.dataset.level.split(' ');
          if (levels.includes(level)) {
            const display = el.dataset.display || (el.tagName === 'SPAN' ? 'inline' : 'block');
            el.style.display = display;
          } else {
            el.style.display = 'none';
          }
        });
      },

      updateInquiry: () => {
        $('inquiry-text').textContent = QUESTIONS[state.lang][config.level];
      },

      reset: () => {
        state.agents = [];
        for (let i = 0; i < config.count; i++) {
          state.agents.push(new Agent(Math.random() * state.width, Math.random() * state.height));
        }
        state.timeSec = 0;
        state.frame = 0;
        state.history = [];
        state.historyAcc = 0;
        state.graph.samples = [];
        state.graph.events = [];
        state.graph.sampleAcc = 0;
      },

      updateConfig: (key, val, displayId, decimals = 1) => {
        if (key === 'count') {
          val = parseInt(val, 10);
        } else {
          val = parseFloat(val);
        }

        if (key === 'count') {
          config.count = val;
          const diff = val - state.agents.length;
          if (diff > 0) {
            for (let i = 0; i < diff; i++) {
              state.agents.push(new Agent(Math.random() * state.width, Math.random() * state.height));
            }
          } else if (diff < 0) {
            state.agents.splice(diff);
          }
        } else {
          config[key] = val;
        }

        if (displayId) {
          $(displayId).textContent = decimals === 0 ? String(val) : val.toFixed(decimals);
        }
      },

      togglePredator: () => {
        config.predatorActive = !config.predatorActive;
        app.updatePredatorButton();
        state.graph.events.push({ t: state.timeSec, active: config.predatorActive });
      },

      updatePredatorButton: () => {
        const btn = $('btn-predator');
        if (config.predatorActive) {
          btn.classList.add('active');
          btn.textContent = I18N[state.lang].labelPredatorOff;
        } else {
          btn.classList.remove('active');
          btn.textContent = I18N[state.lang].labelPredator;
        }
      },

      toggleVision: () => {
        config.showVision = !config.showVision;
        $('check-vision').checked = config.showVision;
      },

      toggleVectors: () => {
        config.showVectors = !config.showVectors;
        $('check-vectors').checked = config.showVectors;
      },

      setIsolation: (val) => { config.isolation = val; },

      loadPreset: (name) => {
        if (name === 'custom') return;
        const p = PRESETS[name];

        config.sepMult = p.sep;
        config.aliMult = p.ali;
        config.cohMult = p.coh;
        config.maxSpeed = p.speed;
        config.visionRadius = p.vision;
        config.kuramotoK = p.k;

        const setUI = (id, val, dispId, decimals = 1) => {
          const el = $(id);
          if (el) { el.value = val; el.dispatchEvent(new Event('input')); }
          if (dispId) $(dispId).textContent = decimals === 0 ? String(val) : val.toFixed(decimals);
        };

        setUI('param-sep', p.sep, 'disp-sep', 1);
        setUI('param-ali', p.ali, 'disp-ali', 1);
        setUI('param-coh', p.coh, 'disp-coh', 1);
        setUI('param-speed', p.speed, 'disp-speed', 1);
        setUI('param-vision', p.vision, 'disp-vision', 0);
        setUI('param-k', p.k, 'disp-k', 1);

        if (name === 'fireflies') {
          app.reset();
        }
      },

      // --- Notebook ---
      captureSnapshot: () => {
        const sparkWindow = state.graph.samples.slice(-60);
        const snapshot = {
          id: Math.random().toString(16).slice(2, 8),
          time: new Date().toISOString(),
          level: config.level,
          params: {
            count: config.count,
            sep: config.sepMult,
            ali: config.aliMult,
            coh: config.cohMult,
            vision: config.visionRadius,
            speed: config.maxSpeed,
            k: config.kuramotoK,
            predator: config.predatorActive
          },
          metrics: { ...state.metrics },
          spark: {
            order: sparkWindow.map((s) => s.order),
            cluster: sparkWindow.map((s) => s.cluster),
            sync: sparkWindow.map((s) => s.sync)
          }
        };
        state.notebook.snapshots.push(snapshot);
        app.renderSnapshots();
      },

      setControlFromCurrent: () => {
        state.notebook.control = {
          time: new Date().toISOString(),
          level: config.level,
          params: {
            count: config.count,
            sep: config.sepMult,
            ali: config.aliMult,
            coh: config.cohMult,
            vision: config.visionRadius,
            speed: config.maxSpeed,
            k: config.kuramotoK,
            predator: config.predatorActive
          },
          metrics: { ...state.metrics }
        };
        state.notebook.compare = true;
        $('toggle-compare').checked = true;
        app.renderControl();
        app.updateCompare();
      },

      clearControl: () => {
        state.notebook.control = null;
        state.notebook.compare = false;
        $('toggle-compare').checked = false;
        app.renderControl();
        app.updateCompare();
      },

      renderControl: () => {
        const controlBody = $('control-body');
        const actions = $('control-actions');
        if (!state.notebook.control) {
          controlBody.textContent = I18N[state.lang].notebookControlEmpty;
          actions.classList.add('hidden');
          return;
        }

        const ctrl = state.notebook.control;
        controlBody.innerHTML = app.formatControlHtml(ctrl);
        actions.classList.remove('hidden');
      },

      formatControlHtml: (ctrl) => {
        const t = (key) => I18N[state.lang][key] || key;
        const levelLabel = app.levelLabel(ctrl.level);
        const predatorLabel = ctrl.params.predator ? t('labelPredatorOnShort') : t('labelPredatorOffShort');
        return `
          <div class="snapshot-meta">${levelLabel} ¬∑ ${new Date(ctrl.time).toLocaleTimeString(state.lang)}</div>
          <div class="snapshot-grid">
            <div>${t('labelCount')}: ${ctrl.params.count}</div>
            <div>Sep: ${ctrl.params.sep.toFixed(1)}</div>
            <div>Ali: ${ctrl.params.ali.toFixed(1)}</div>
            <div>Coh: ${ctrl.params.coh.toFixed(1)}</div>
            <div>${t('labelVisionRadius')}: ${Math.round(ctrl.params.vision)}</div>
            <div>${t('labelSpeed')}: ${ctrl.params.speed.toFixed(1)}</div>
            <div>K: ${ctrl.params.k.toFixed(1)}</div>
            <div>${predatorLabel}</div>
            <div>${t('metricOrder')}: ${ctrl.metrics.order.toFixed(2)}</div>
            <div>${t('metricCluster')}: ${(ctrl.metrics.cluster * 100).toFixed(0)}%</div>
            <div>${t('metricSync')}: ${ctrl.metrics.sync.toFixed(2)}</div>
          </div>
        `;
      },

      renderSnapshots: () => {
        const list = $('snapshots-list');
        list.innerHTML = '';
        if (state.notebook.snapshots.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'small-muted';
          empty.textContent = I18N[state.lang].notebookSnapshotsEmpty;
          list.appendChild(empty);
          return;
        }

        const t = (key) => I18N[state.lang][key] || key;
        const snapshots = [...state.notebook.snapshots].reverse();

        snapshots.forEach((snap) => {
          const card = document.createElement('div');
          card.className = 'snapshot-card';

          const meta = document.createElement('div');
          meta.className = 'snapshot-meta';
          meta.textContent = `${app.levelLabel(snap.level)} ¬∑ ${new Date(snap.time).toLocaleTimeString(state.lang)}`;

          const grid = document.createElement('div');
          grid.className = 'snapshot-grid';
          grid.innerHTML = `
            <div>${t('labelCount')}: ${snap.params.count}</div>
            <div>Sep: ${snap.params.sep.toFixed(1)}</div>
            <div>Ali: ${snap.params.ali.toFixed(1)}</div>
            <div>Coh: ${snap.params.coh.toFixed(1)}</div>
            <div>${t('labelVisionRadius')}: ${Math.round(snap.params.vision)}</div>
            <div>${t('labelSpeed')}: ${snap.params.speed.toFixed(1)}</div>
            <div>K: ${snap.params.k.toFixed(1)}</div>
            <div>${snap.params.predator ? t('labelPredatorOnShort') : t('labelPredatorOffShort')}</div>
            <div>${t('metricOrder')}: ${snap.metrics.order.toFixed(2)}</div>
            <div>${t('metricCluster')}: ${(snap.metrics.cluster * 100).toFixed(0)}%</div>
            <div>${t('metricSync')}: ${snap.metrics.sync.toFixed(2)}</div>
          `;

          const spark = document.createElement('canvas');
          spark.className = 'sparkline';

          const actions = document.createElement('div');
          actions.className = 'snapshot-actions';
          const useBtn = document.createElement('button');
          useBtn.textContent = t('notebookUseAsControl');
          useBtn.addEventListener('click', () => {
            state.notebook.control = {
              time: snap.time,
              level: snap.level,
              params: snap.params,
              metrics: snap.metrics
            };
            state.notebook.compare = true;
            $('toggle-compare').checked = true;
            app.renderControl();
            app.updateCompare();
          });
          const delBtn = document.createElement('button');
          delBtn.textContent = t('notebookDelete');
          delBtn.addEventListener('click', () => {
            state.notebook.snapshots = state.notebook.snapshots.filter((s) => s.id !== snap.id);
            if (state.notebook.control && state.notebook.control.time === snap.time) {
              app.clearControl();
            }
            app.renderSnapshots();
          });

          actions.appendChild(useBtn);
          actions.appendChild(delBtn);

          card.appendChild(meta);
          card.appendChild(grid);
          card.appendChild(spark);
          card.appendChild(actions);
          list.appendChild(card);

          app.drawSparkline(spark, snap.spark);
        });
      },

      drawSparkline: (canvas, spark) => {
        const ctx = canvas.getContext('2d');
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        ctx.clearRect(0, 0, width, height);
        ctx.lineWidth = 1.2;
        ctx.strokeStyle = '#1e293b';
        ctx.strokeRect(0, 0, width, height);

        const drawLine = (values, color) => {
          if (!values || values.length < 2) return;
          ctx.beginPath();
          values.forEach((v, i) => {
            const x = (i / (values.length - 1)) * (width - 6) + 3;
            const y = (1 - v) * (height - 6) + 3;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.strokeStyle = color;
          ctx.stroke();
        };

        drawLine(spark.order, getComputedStyle(document.documentElement).getPropertyValue('--graph-order'));
        drawLine(spark.cluster, getComputedStyle(document.documentElement).getPropertyValue('--graph-cluster'));
        drawLine(spark.sync, getComputedStyle(document.documentElement).getPropertyValue('--graph-sync'));
      },

      updateCompare: () => {
        const setVal = (id, value, isPercent = false) => {
          const el = $(id);
          if (!state.notebook.control || !state.notebook.compare) {
            el.textContent = '‚Äî';
            el.classList.remove('pos', 'neg');
            return;
          }
          const sign = value > 0 ? '+' : '';
          const text = isPercent ? `${sign}${(value * 100).toFixed(0)}%` : `${sign}${value.toFixed(2)}`;
          el.textContent = text;
          el.classList.toggle('pos', value > 0);
          el.classList.toggle('neg', value < 0);
        };

        if (!state.notebook.control || !state.notebook.compare) {
          setVal('cmp-order', 0);
          setVal('cmp-cluster', 0, true);
          setVal('cmp-sync', 0);
          return;
        }

        setVal('cmp-order', state.metrics.order - state.notebook.control.metrics.order);
        setVal('cmp-cluster', state.metrics.cluster - state.notebook.control.metrics.cluster, true);
        setVal('cmp-sync', state.metrics.sync - state.notebook.control.metrics.sync);
      },

      levelLabel: (level) => {
        const t = (key) => I18N[state.lang][key] || key;
        if (level === 'basico') return t('levelBasicoShort');
        if (level === 'media') return t('levelMediaShort');
        return t('levelAvanzadoShort');
      },

      // --- Analysis & Export ---
      calculateMetrics: () => {
        let sumVel = { x: 0, y: 0 };
        let syncSum = { x: 0, y: 0 };
        let clustered = 0;

        const N = state.agents.length;
        if (N === 0) return;

        state.agents.forEach((a) => {
          const normVel = Vec2.normalize(a.vel);
          sumVel = Vec2.add(sumVel, normVel);
          syncSum.x += Math.cos(a.phase);
          syncSum.y += Math.sin(a.phase);
          if (a.neighborCount >= 3) clustered += 1;
        });

        const psi = Vec2.mag(sumVel) / N;
        const r = Math.sqrt(syncSum.x ** 2 + syncSum.y ** 2) / N;
        const cluster = clustered / N;

        state.metrics = { order: psi, cluster, sync: r };

        $('val-order').textContent = psi.toFixed(2);
        $('val-cluster').textContent = `${(cluster * 100).toFixed(0)}%`;
        $('val-count').textContent = N;

        if (config.level === 'avanzado') $('val-sync').textContent = r.toFixed(2);

        const totalSeconds = Math.floor(state.timeSec);
        const min = Math.floor(totalSeconds / 60);
        const sec = totalSeconds % 60;
        $('val-time').textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      },

      updateGraph: (dtMs) => {
        state.graph.sampleAcc += dtMs;
        if (state.graph.sampleAcc < state.graph.sampleMs) return;
        state.graph.sampleAcc = 0;

        state.graph.samples.push({
          t: state.timeSec,
          order: state.metrics.order,
          cluster: state.metrics.cluster,
          sync: state.metrics.sync
        });

        const cutoff = state.timeSec - state.graph.windowSec;
        while (state.graph.samples.length && state.graph.samples[0].t < cutoff) {
          state.graph.samples.shift();
        }
        state.graph.events = state.graph.events.filter((e) => e.t >= cutoff);
      },

      drawGraph: () => {
        const ctx = app.graphCtx;
        const width = app.graphCanvas.width / (window.devicePixelRatio || 1);
        const height = app.graphCanvas.height / (window.devicePixelRatio || 1);

        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = 'rgba(2,6,23,0.4)';
        ctx.fillRect(0, 0, width, height);

        const pad = 22;
        const innerW = width - pad * 2;
        const innerH = height - pad * 2;
        const start = state.timeSec - state.graph.windowSec;

        ctx.strokeStyle = 'rgba(148,163,184,0.25)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(pad, pad);
        ctx.lineTo(pad, height - pad);
        ctx.lineTo(width - pad, height - pad);
        ctx.stroke();

        const drawSeries = (values, color) => {
          if (!values.length) return;
          ctx.beginPath();
          values.forEach((s, i) => {
            const x = pad + ((s.t - start) / state.graph.windowSec) * innerW;
            const y = pad + (1 - s.value) * innerH;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.stroke();
        };

        const series = state.graph.samples.map((s) => ({
          t: s.t,
          order: s.order,
          cluster: s.cluster,
          sync: s.sync
        }));

        const rootStyles = getComputedStyle(document.documentElement);
        const colorOrder = rootStyles.getPropertyValue('--graph-order').trim() || '#38bdf8';
        const colorCluster = rootStyles.getPropertyValue('--graph-cluster').trim() || '#22c55e';
        const colorSync = rootStyles.getPropertyValue('--graph-sync').trim() || '#fbbf24';

        if (state.graph.series.order) {
          drawSeries(series.map((s) => ({ t: s.t, value: s.order })), colorOrder);
        }
        if (state.graph.series.cluster) {
          drawSeries(series.map((s) => ({ t: s.t, value: s.cluster })), colorCluster);
        }
        if (config.level === 'avanzado' && state.graph.series.sync) {
          drawSeries(series.map((s) => ({ t: s.t, value: s.sync })), colorSync);
        }

        state.graph.events.forEach((evt) => {
          const x = pad + ((evt.t - start) / state.graph.windowSec) * innerW;
          ctx.beginPath();
          ctx.moveTo(x, pad);
          ctx.lineTo(x, height - pad);
          ctx.strokeStyle = evt.active ? 'rgba(239,68,68,0.8)' : 'rgba(148,163,184,0.5)';
          ctx.lineWidth = 1;
          ctx.stroke();
        });
      },

      recordHistory: (dt) => {
        if (config.level === 'basico') return;
        state.historyAcc += dt;
        if (state.historyAcc < 1) return;
        state.historyAcc = 0;
        state.history.push({
          time: state.timeSec.toFixed(1),
          agents: state.agents.length,
          order: state.metrics.order.toFixed(3),
          cluster: state.metrics.cluster.toFixed(3),
          sync: state.metrics.sync.toFixed(3),
          predator: config.predatorActive ? 1 : 0
        });
      },

      exportData: (format) => {
        if (state.history.length === 0) { alert(I18N[state.lang].alertNoData); return; }

        let content = "";
        let mime = "";

        if (format === 'csv') {
          content = "Time,Agents,OrderParam,Cluster,SyncParam,Predator\\n";
          state.history.forEach((row) => {
            content += `${row.time},${row.agents},${row.order},${row.cluster},${row.sync},${row.predator}\\n`;
          });
          mime = "text/csv";
        } else {
          content = JSON.stringify(state.history, null, 2);
          mime = "application/json";
        }

        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `animal_groups_data.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      },

      toggleGraph: () => {
        state.graphOpen = !state.graphOpen;
        $('graph-drawer').classList.toggle('open', state.graphOpen);
      },

      buildSpatialHash: (agents, cellSize) => {
        const grid = new Map();
        for (const a of agents) {
          const cx = Math.floor(a.pos.x / cellSize);
          const cy = Math.floor(a.pos.y / cellSize);
          const key = `${cx},${cy}`;
          if (!grid.has(key)) grid.set(key, []);
          grid.get(key).push(a);
        }
        return grid;
      },

      getNeighbors: (agent, grid, cellSize) => {
        const cx = Math.floor(agent.pos.x / cellSize);
        const cy = Math.floor(agent.pos.y / cellSize);
        const neighbors = [];
        for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
            const key = `${cx + dx},${cy + dy}`;
            const cell = grid.get(key);
            if (cell) neighbors.push(...cell);
          }
        }
        return neighbors;
      },

      // --- Rendering ---
      draw: () => {
        const ctx = app.ctx;
        ctx.clearRect(0, 0, state.width, state.height);

        const cellSize = Math.max(20, config.visionRadius);
        const grid = app.buildSpatialHash(state.agents, cellSize);

        if (config.predatorActive) {
          ctx.beginPath();
          ctx.arc(state.predator.x, state.predator.y, 15, 0, Math.PI * 2);
          ctx.fillStyle = '#ef4444';
          ctx.fill();
          ctx.strokeStyle = 'rgba(239, 68, 68, 0.3)';
          ctx.lineWidth = 150;
          ctx.stroke();
        }

        state.agents.forEach((a, index) => {
          const neighbors = app.getNeighbors(a, grid, cellSize);
          a.flock(neighbors);
          a.update();

          if (config.showVision || index === 0) {
            ctx.beginPath();
            a.trail.forEach((p, i) => {
              if (i === 0) ctx.moveTo(p.x, p.y);
              else ctx.lineTo(p.x, p.y);
            });
            ctx.strokeStyle = `rgba(56, 189, 248, 0.2)`;
            ctx.stroke();
          }

          if (config.showVision || index === 0) {
            ctx.beginPath();
            ctx.arc(a.pos.x, a.pos.y, config.visionRadius, 0, Math.PI * 2);
            ctx.strokeStyle = index === 0 ? 'rgba(255, 215, 0, 0.3)' : 'rgba(255, 255, 255, 0.05)';
            ctx.stroke();
          }

          ctx.save();
          ctx.translate(a.pos.x, a.pos.y);
          ctx.rotate(Math.atan2(a.vel.y, a.vel.x));

          ctx.beginPath();
          ctx.moveTo(6, 0);
          ctx.lineTo(-4, 3);
          ctx.lineTo(-4, -3);
          ctx.closePath();

          if (index === 0) {
            ctx.fillStyle = '#fbbf24';
          } else if (config.kuramotoK > 0) {
            const hue = (a.phase * 180 / Math.PI) % 360;
            ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
          } else {
            ctx.fillStyle = '#38bdf8';
          }
          ctx.fill();
          ctx.restore();

          if ((config.showVectors || index === 0) && config.level !== 'basico') {
            const drawVec = (v, color) => {
              if (Vec2.mag(v) === 0) return;
              const scale = 800;
              ctx.beginPath();
              ctx.moveTo(a.pos.x, a.pos.y);
              ctx.lineTo(a.pos.x + v.x * scale, a.pos.y + v.y * scale);
              ctx.strokeStyle = color;
              ctx.lineWidth = 1;
              ctx.stroke();
            };
            drawVec(a.debugVectors.sep, '#ef4444');
            drawVec(a.debugVectors.ali, '#22c55e');
            drawVec(a.debugVectors.coh, '#38bdf8');
          }
        });

        app.calculateMetrics();
      },

      loop: (timestamp) => {
        const dt = Math.min((timestamp - state.lastFrame) / 1000, 0.05) || 0.016;
        state.lastFrame = timestamp;

        if (!config.paused) {
          state.timeSec += dt;
          state.frame += 1;
          app.draw();
          app.recordHistory(dt);
          app.updateGraph(dt * 1000);
        }

        const fpsNow = 1 / dt;
        state.fps = state.fps ? state.fps * 0.9 + fpsNow * 0.1 : fpsNow;
        if (state.frame % 10 === 0) $('val-fps').textContent = state.fps.toFixed(0);

        if (state.graphOpen) app.drawGraph();
        if (state.notebook.compare) app.updateCompare();

        requestAnimationFrame(app.loop);
      }
    };

    class Agent {
      constructor(x, y) {
        this.pos = { x, y };
        this.vel = { x: Math.random() * 2 - 1, y: Math.random() * 2 - 1 };
        this.acc = { x: 0, y: 0 };
        this.phase = Math.random() * 2 * Math.PI;
        this.freq = 0.05 + Math.random() * 0.02;
        this.trail = [];
        this.neighborCount = 0;
      }

      edges() {
        if (this.pos.x > state.width) this.pos.x = 0;
        if (this.pos.x < 0) this.pos.x = state.width;
        if (this.pos.y > state.height) this.pos.y = 0;
        if (this.pos.y < 0) this.pos.y = state.height;
      }

      flock(neighbors) {
        let sep = { x: 0, y: 0 };
        let ali = { x: 0, y: 0 };
        let coh = { x: 0, y: 0 };
        let count = 0;
        let syncForce = 0;

        for (let other of neighbors) {
          if (other === this) continue;
          const d = Vec2.dist(this.pos, other.pos);
          if (d > 0 && d < config.visionRadius) {
            let diff = Vec2.sub(this.pos, other.pos);
            diff = Vec2.normalize(diff);
            diff = Vec2.div(diff, d);
            sep = Vec2.add(sep, diff);

            ali = Vec2.add(ali, other.vel);
            coh = Vec2.add(coh, other.pos);

            if (config.kuramotoK > 0) {
              syncForce += Math.sin(other.phase - this.phase);
            }
            count++;
          }
        }

        this.neighborCount = count;
        this.debugVectors = { sep: { x: 0, y: 0 }, ali: { x: 0, y: 0 }, coh: { x: 0, y: 0 } };

        if (count > 0) {
          sep = Vec2.div(sep, count);
          if (Vec2.mag(sep) > 0) {
            sep = Vec2.normalize(sep);
            sep = Vec2.mult(sep, config.maxSpeed);
            sep = Vec2.sub(sep, this.vel);
            sep = Vec2.limit(sep, config.maxForce);
          }

          ali = Vec2.div(ali, count);
          if (Vec2.mag(ali) > 0) {
            ali = Vec2.normalize(ali);
            ali = Vec2.mult(ali, config.maxSpeed);
            ali = Vec2.sub(ali, this.vel);
            ali = Vec2.limit(ali, config.maxForce);
          }

          coh = Vec2.div(coh, count);
          coh = Vec2.sub(coh, this.pos);
          if (Vec2.mag(coh) > 0) {
            coh = Vec2.normalize(coh);
            coh = Vec2.mult(coh, config.maxSpeed);
            coh = Vec2.sub(coh, this.vel);
            coh = Vec2.limit(coh, config.maxForce);
          }

          const K_norm = config.kuramotoK / count;
          this.phase += this.freq + (K_norm * syncForce);
        } else {
          this.phase += this.freq;
        }

        if (config.isolation === 'all' || config.isolation === 'sep') sep = Vec2.mult(sep, config.sepMult);
        else sep = { x: 0, y: 0 };

        if (config.isolation === 'all' || config.isolation === 'ali') ali = Vec2.mult(ali, config.aliMult);
        else ali = { x: 0, y: 0 };

        if (config.isolation === 'all' || config.isolation === 'coh') coh = Vec2.mult(coh, config.cohMult);
        else coh = { x: 0, y: 0 };

        let predForce = { x: 0, y: 0 };
        if (config.predatorActive) {
          let dPred = Vec2.dist(this.pos, state.predator);
          if (dPred < 150) {
            let flee = Vec2.sub(this.pos, state.predator);
            flee = Vec2.normalize(flee);
            flee = Vec2.mult(flee, config.maxForce * 5);
            predForce = flee;
          }
        }

        this.acc = Vec2.add(this.acc, sep);
        this.acc = Vec2.add(this.acc, ali);
        this.acc = Vec2.add(this.acc, coh);
        this.acc = Vec2.add(this.acc, predForce);

        this.debugVectors.sep = sep;
        this.debugVectors.ali = ali;
        this.debugVectors.coh = coh;
      }

      update() {
        this.vel = Vec2.add(this.vel, this.acc);
        this.vel = Vec2.limit(this.vel, config.maxSpeed);
        this.pos = Vec2.add(this.pos, this.vel);
        this.acc = { x: 0, y: 0 };
        this.edges();

        if (this.phase > Math.PI * 2) this.phase -= Math.PI * 2;

        if (state.frame % 5 === 0) {
          this.trail.push({ ...this.pos });
          if (this.trail.length > 10) this.trail.shift();
        }
      }
    }

    window.onload = app.init;
  </script>
</body>
</html>
